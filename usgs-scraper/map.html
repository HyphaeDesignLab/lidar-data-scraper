<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src='//api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js'></script>
    <link href='//api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css' rel='stylesheet'/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        #map-controls {
            position: fixed;
            top: 0;
            right: 0;
            background-color: maroon;
            color: white;
            border: 1px solid grey;
        }

        #map-controls input {
            display: block;
        }
    </style>
</head>
<body>
<div id="log"
     style="white-space: pre-wrap; position: fixed; top: 0; right: 0; z-index: 123; width: 50%; max-width: 500px; min-width: 300px; height: 200px; overflow-y: scroll;"></div>
<div id='map' style='width: 100vw; height: 80vh;'></div>

<script>
    const logEl = document.querySelector('#log');
    const log = (...things) => {
        things.forEach(thing => {
            logEl.innerHTML += thing + " \n";
        });
    };
    mapboxgl.accessToken = 'pk.eyJ1IjoiaHlwaGFlLWxhYiIsImEiOiJjazN4czF2M2swZmhkM25vMnd2MXZrYm11In0.LS_KIw8THi2qIethuAf2mw';

    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/hyphae-lab/clb2h2e48000015o4w0b0tyig',
        center: [-88.20513532089814,34.98027232735532],
        zoom: 12
    });

    function loadTiles(project, parentFeatureId) {
        parentFeatureId = parseInt(parentFeatureId)
        fetch(`projects/${project}/xml_tiles.json`)
            .then(response => response.json())
            .then(data => {
                if (!data.features[0].id) {
                    const baseNumber = parentFeatureId * Math.pow(10, String(data.features.length).length)
                    data.features.forEach((feature, i) => {
                        feature.id =  baseNumber + (i+1);
                    })
                }

                // remove feature whose sub-tiles were show
                tilesData['leaves'].features.forEach((feature, i) => {
                    if (feature.id === parentFeatureId) {
                        tilesData['leaves'].features.splice(i, 1)
                    }
                });
                // update source
                sources['leaves'].setData(tilesData['leaves']); // update

                layersIds.push(project);
                map.addSource(project, {type: 'geojson', data});
                map.addLayer({
                    'id': project,
                    'type': 'fill',
                    'source': project,
                    "paint": {
                        "fill-color": "#aaaaff",
                        "fill-opacity": .9,
                        "fill-outline-color": "#0000aa"
                    }
                });
            });
    }

    let mapPopup = null;
    let layersIds = [];
    let highlightLayerSource = null;
    let sources = {}

    const tilesData = {};
    map.on('load', function () {
        fetch('projects/leaves-status.json')
            .then(response => response.json())
            .then(data => {
                tilesData['leaves'] = data;
                layersIds.push('leaves');
                if (!data.features[0].id) {
                    data.features.forEach((feature, i) => {
                        feature.id = (i+1);
                    })
                }
                map.addSource('highlight', {type: 'geojson', data: {type: 'FeatureCollection', features: []}});
                map.addLayer({
                    'id': 'highlight',
                    'type': 'line',
                    'source': 'highlight',
                    "paint": {
                        "line-color": 'black',
                        "line-width": 2
                    }
                });
                highlightLayerSource = map.getSource('highlight')

                map.addSource('leaves', {type: 'geojson', data});
                sources['leaves'] = map.getSource('leaves')
                map.addLayer({
                    'id': 'leaves',
                    'type': 'fill',
                    'source': 'leaves',
                    "paint": {
                        "fill-color": ["case",
                            ['==', ['get', 'leaves'], 'on'], ["rgba", 90, 255, 112, .5], // "#5aff70",
                            ['==', ['get', 'leaves'], 'off'], ["rgba", 252, 174, 81, .5], // "#fcae51"
                            ["rgba", 252, 81, 121, .5] // "#fc5179"
                        ],
                        "fill-opacity": .8, // default
                        "fill-outline-color": ['case',
                            ['==', ['feature-state', 'focused'], true], "#222222",
                            ['==', ['get', 'leaves'], 'on'], "#047e16",
                            "#a94202"
                        ]
                    }
                });

                map.on('click', function(e) {
                    var features = map.queryRenderedFeatures(e.point, {layers: layersIds});
                    console.log(features);

                    if (!features.length) {
                        highlightLayerSource.setData({type: 'FeatureCollection', features: []});
                        return;
                    }

                    var markerHeight = 50, markerRadius = 10, linearOffset = 25;
                    var popupOffsets = {
                        'top': [0, 0],
                        'top-left': [0,0],
                        'top-right': [0,0],
                        'bottom': [0, -markerHeight],
                        'bottom-left': [linearOffset, (markerHeight - markerRadius + linearOffset) * -1],
                        'bottom-right': [-linearOffset, (markerHeight - markerRadius + linearOffset) * -1],
                        'left': [markerRadius, (markerHeight - markerRadius) * -1],
                        'right': [-markerRadius, (markerHeight - markerRadius) * -1]
                    };

                    const feature = features[0];
                    highlightLayerSource.setData({type: 'FeatureCollection', features: [feature]});
                    const props = feature.properties;
                    const linkDrilldown = props.is_bbox ? `<div><a href="#" data-load-more-tiles data-project="${props.project}" data-feature-id="${feature.id}">see tiles</a></div>`:'';
                    mapPopup = new mapboxgl.Popup({offset: popupOffsets, className: 'my-class', closeOnClick: true, closeOnMove: true})
                        .setLngLat(e.lngLat)
                        .setHTML(`
<div><strong>${props.project.replace('/', ': ').replaceAll('_', ' ')}</strong></div>
<div>
leaves are ${props.leaves.toUpperCase()}<br/>
from ${props.date_start.replace(/(\d{4})(\d\d)(\d\d)/, '$1-$2-$3')} to ${props.date_end.replace(/(\d{4})(\d\d)(\d\d)/, '$1-$2-$3')}<br/>
${props.tile_count} tiles
<br/>${linkDrilldown}</div>
`)
                        .setMaxWidth("300px")
                        .addTo(map);
                    if (props.is_bbox) {
                        console.log('all')
                        document.querySelector('[data-load-more-tiles]').addEventListener('click', e => {
                            e.preventDefault();
                            e.stopPropagation();
                            loadTiles(e.target.dataset.project, e.target.dataset.featureId);
                        })
                    }
                });


            });

    });
</script>


</body>
</html>